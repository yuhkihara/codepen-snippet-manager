# ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

> âš ï¸ **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯v1ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ã§ã™ã€‚**
> æœ€æ–°ç‰ˆã¯ [visual-editor-architecture-v2.md](./visual-editor-architecture-v2.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
> v1ã§ã¯iframeãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆã§ã—ãŸãŒã€v2ã§Shadow DOMãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚

**ä½œæˆæ—¥**: 2026-01-17
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆv2ã«ç§»è¡Œæ¸ˆã¿ï¼‰

---

## 1. æ©Ÿèƒ½æ¦‚è¦

### 1.1 ç›®æ¨™

ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸Šã§ç›´æ„Ÿçš„ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ“ä½œã§ãã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½

| æ©Ÿèƒ½ | èª¬æ˜ |
|------|------|
| **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé¸æŠ** | 1ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹ |
| **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ** | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸Šã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºå¤‰æ›´ |
| **ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†** | ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†å¯èƒ½é ˜åŸŸã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥ç·¨é›† |
| **åŒæ–¹å‘åŒæœŸ** | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å¤‰æ›´ãŒMonaco Editorã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜  |

---

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè­˜åˆ¥ã‚·ã‚¹ãƒ†ãƒ 

### 2.1 ãƒ‡ãƒ¼ã‚¿å±æ€§è¦ç´„

```html
<!-- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆè¦ç´  -->
<div data-component-id="unique-id-123" data-component-type="header">

  <!-- ç·¨é›†å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸ -->
  <h1 data-editable="title">ã“ã“ã‚’ç·¨é›†ã§ãã¾ã™</h1>
  <p data-editable="subtitle">ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</p>

  <!-- ç·¨é›†ä¸å¯ã®è¦ç´  -->
  <img src="logo.png" alt="Logo" />
</div>
```

### 2.2 å±æ€§å®šç¾©

| å±æ€§ | ç”¨é€” | å€¤ |
|------|------|-----|
| `data-component-id` | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸€æ„è­˜åˆ¥å­ | UUID or ã‚¹ãƒ‹ãƒšãƒƒãƒˆID |
| `data-component-type` | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç¨®é¡ | `header`, `content`, `footer`, `cta`, etc. |
| `data-editable` | ç·¨é›†å¯èƒ½é ˜åŸŸã®è­˜åˆ¥å­ | ä»»æ„ã®æ–‡å­—åˆ—ï¼ˆåŒä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ä¸€æ„ï¼‰ |
| `data-sortable` | ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãƒ•ãƒ©ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | `true` / `false` |

### 2.3 ã‚¹ãƒ‹ãƒšãƒƒãƒˆæŒ¿å…¥æ™‚ã®IDä»˜ä¸

```typescript
// ã‚¹ãƒ‹ãƒšãƒƒãƒˆãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã«IDã‚’è‡ªå‹•ä»˜ä¸
function wrapWithComponentId(html: string, snippetId: string): string {
  const uniqueId = `${snippetId}-${Date.now()}`;
  return `<!-- component:${uniqueId} -->\n<div data-component-id="${uniqueId}">\n${html}\n</div>\n<!-- /component:${uniqueId} -->`;
}
```

---

## 3. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 3.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EmailComposerClient                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              â”‚                 â”‚                         â”‚  â”‚
â”‚  â”‚  Snippets    â”‚  Monaco Editor  â”‚  Visual Preview Editor  â”‚  â”‚
â”‚  â”‚  Sidebar     â”‚                 â”‚  (iframe)               â”‚  â”‚
â”‚  â”‚              â”‚                 â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                    â”‚                 â”‚
â”‚         â”‚                â”‚                    â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                          â”‚                                      â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                 â”‚  Zustand Store  â”‚                             â”‚
â”‚                 â”‚  (SSOT)         â”‚                             â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | è²¬å‹™ |
|---------------|------|
| `VisualPreviewEditor.tsx` | iframeå†…ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç·¨é›†å…¨ä½“ã‚’ç®¡ç† |
| `PreviewBridge.ts` | è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ â†” iframeé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚° |
| `ComponentOverlay.tsx` | é¸æŠçŠ¶æ…‹ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º |
| `InlineTextEditor.tsx` | ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã®UI |

### 3.3 Zustand Storeæ‹¡å¼µ

```typescript
interface EmailComposerState {
  // æ—¢å­˜
  html: string;
  setHtml: (html: string) => void;

  // æ–°è¦è¿½åŠ 
  selectedComponentId: string | null;
  setSelectedComponentId: (id: string | null) => void;

  editingField: { componentId: string; fieldName: string } | null;
  setEditingField: (field: { componentId: string; fieldName: string } | null) => void;

  componentOrder: string[];  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆIDã®é…åˆ—ï¼ˆé †åºç®¡ç†ï¼‰
  reorderComponents: (fromIndex: number, toIndex: number) => void;

  updateComponentText: (componentId: string, fieldName: string, text: string) => void;
}
```

---

## 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### 4.1 è¦ª â†’ iframe

```typescript
type ParentToIframeMessage =
  | { type: 'UPDATE_HTML'; html: string }
  | { type: 'SELECT_COMPONENT'; componentId: string }
  | { type: 'DESELECT_ALL' }
  | { type: 'ENABLE_EDIT_MODE' }
  | { type: 'DISABLE_EDIT_MODE' };
```

### 4.2 iframe â†’ è¦ª

```typescript
type IframeToParentMessage =
  | { type: 'COMPONENT_CLICKED'; componentId: string }
  | { type: 'COMPONENT_DOUBLE_CLICKED'; componentId: string; fieldName: string }
  | { type: 'COMPONENT_REORDERED'; fromIndex: number; toIndex: number }
  | { type: 'TEXT_CHANGED'; componentId: string; fieldName: string; newText: string }
  | { type: 'EDIT_COMPLETED'; componentId: string; fieldName: string }
  | { type: 'IFRAME_READY' };
```

---

## 5. ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

### 5.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé¸æŠãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ      â”‚
â”‚  ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ  â”‚
â”‚  ã‚’ã‚¯ãƒªãƒƒã‚¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  iframeå†…ã§      â”‚
â”‚  clickæ¤œçŸ¥       â”‚
â”‚  closest([data-  â”‚
â”‚  component-id])  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  postMessage    â”‚
â”‚  COMPONENT_     â”‚
â”‚  CLICKED        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¦ªãŒå—ä¿¡       â”‚
â”‚  setSelected    â”‚
â”‚  ComponentId()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storeæ›´æ–°      â”‚
â”‚  â†’ UIå†æç”»     â”‚
â”‚  â†’ é¸æŠæ è¡¨ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ      â”‚
â”‚  ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ  â”‚
â”‚  ã‚’ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dragstart      â”‚
â”‚  ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®    â”‚
â”‚  è¦–è¦šåŠ¹æœé©ç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dragover       â”‚
â”‚  ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®    â”‚
â”‚  ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿    â”‚
â”‚  è¡¨ç¤º           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  drop           â”‚
â”‚  æ–°ã—ã„é †åºã‚’    â”‚
â”‚  è¨ˆç®—           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  postMessage    â”‚
â”‚  COMPONENT_     â”‚
â”‚  REORDERED      â”‚
â”‚  {from, to}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¦ªãŒå—ä¿¡       â”‚
â”‚  reorder        â”‚
â”‚  Components()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTMLå†æ§‹ç¯‰     â”‚
â”‚  ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ  â”‚
â”‚  é †åºã‚’åæ˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Monaco Editor  â”‚
â”‚  æ›´æ–°           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ      â”‚
â”‚  ç·¨é›†å¯èƒ½é ˜åŸŸ    â”‚
â”‚  ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [data-editable]â”‚
â”‚  è¦ç´ ã‚’æ¤œå‡º     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  postMessage    â”‚
â”‚  COMPONENT_     â”‚
â”‚  DOUBLE_CLICKED â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¦ªãŒå—ä¿¡       â”‚
â”‚  setEditingFieldâ”‚
â”‚  ({id, field})  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  contenteditableâ”‚
â”‚  = "true"       â”‚
â”‚  ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç·¨é›†ä¸­                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  input/keyup ã‚¤ãƒ™ãƒ³ãƒˆ        â”‚    â”‚
â”‚  â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚         â–¼                   â”‚    â”‚
â”‚  â”‚  æ”¹è¡Œã‚’<br>ã«å¤‰æ›            â”‚    â”‚
â”‚  â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚         â–¼                   â”‚    â”‚
â”‚  â”‚  postMessage TEXT_CHANGED   â”‚    â”‚
â”‚  â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚         â–¼                   â”‚    â”‚
â”‚  â”‚  Storeæ›´æ–° â†’ Monacoæ›´æ–°     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼ (blur ã¾ãŸã¯ Escape)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  postMessage    â”‚
â”‚  EDIT_COMPLETED â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  contenteditableâ”‚
â”‚  = "false"      â”‚
â”‚  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. HTMLè§£æãƒ»å†æ§‹ç¯‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 6.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæŠ½å‡º

```typescript
interface ParsedComponent {
  id: string;
  type: string;
  html: string;
  editableFields: Map<string, string>;  // fieldName â†’ currentText
  startIndex: number;  // å…ƒHTMLã§ã®é–‹å§‹ä½ç½®
  endIndex: number;    // å…ƒHTMLã§ã®çµ‚äº†ä½ç½®
}

function parseComponents(html: string): ParsedComponent[] {
  // ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã¾ãŸã¯data-component-idå±æ€§ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ¤œå‡º
  // æ­£è¦è¡¨ç¾ + DOMParserä½µç”¨
}
```

### 6.2 ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°

```typescript
function updateEditableText(
  html: string,
  componentId: string,
  fieldName: string,
  newText: string
): string {
  // 1. æ”¹è¡Œã‚’<br>ã«å¤‰æ›
  const htmlText = newText.replace(/\n/g, '<br>');

  // 2. DOMParserã§HTMLè§£æ
  // 3. å¯¾è±¡è¦ç´ ã‚’ç‰¹å®šã—ã¦æ›´æ–°
  // 4. ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦è¿”å´
}
```

### 6.3 é †åºå¤‰æ›´

```typescript
function reorderComponentsInHtml(
  html: string,
  fromIndex: number,
  toIndex: number
): string {
  // 1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡º
  // 2. é…åˆ—å†…ã§é †åºå¤‰æ›´
  // 3. å†æ§‹ç¯‰ã—ã¦è¿”å´
}
```

---

## 7. iframeå†…ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### 7.1 æ³¨å…¥ã™ã‚‹JavaScript

```javascript
// preview-editor.js - iframeå†…ã§å®Ÿè¡Œ
(function() {
  let selectedComponent = null;
  let editingElement = null;

  // é¸æŠã‚¹ã‚¿ã‚¤ãƒ«
  const selectionStyle = document.createElement('style');
  selectionStyle.textContent = `
    [data-component-id].selected {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    [data-component-id]:hover:not(.selected) {
      outline: 1px dashed #94a3b8;
      outline-offset: 2px;
    }
    [data-component-id].dragging {
      opacity: 0.5;
    }
    .drop-indicator {
      height: 4px;
      background: #3b82f6;
      margin: 4px 0;
    }
    [data-editable].editing {
      outline: 2px solid #10b981;
      min-height: 1em;
    }
  `;
  document.head.appendChild(selectionStyle);

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  document.body.addEventListener('click', handleClick);
  document.body.addEventListener('dblclick', handleDoubleClick);
  // ... ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ

  // è¦ªã¨ã®é€šä¿¡
  window.addEventListener('message', handleParentMessage);
  window.parent.postMessage({ type: 'IFRAME_READY' }, '*');
})();
```

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 8.1 iframe sandbox

```html
<iframe
  sandbox="allow-scripts"
  <!-- allow-same-originã¯ä½¿ç”¨ã—ãªã„ï¼ˆXSSé˜²æ­¢ï¼‰ -->
/>
```

### 8.2 postMessageæ¤œè¨¼

```typescript
// è¦ªå´
window.addEventListener('message', (e) => {
  // originã¯æ¤œè¨¼ã—ãªã„ï¼ˆsandbox iframe ã¯null originï¼‰
  // ä»£ã‚ã‚Šã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã‚’å³å¯†ã«æ¤œè¨¼
  if (!isValidIframeMessage(e.data)) return;
});

function isValidIframeMessage(data: unknown): data is IframeToParentMessage {
  // Zodã§ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
}
```

### 8.3 HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚: æ—¢å­˜ã®`sanitizeHTML()`ã‚’ç¶™ç¶šä½¿ç”¨
- Monacoæ›´æ–°æ™‚: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã€æ§‹é€ ã¯ä¿æŒ

---

## 9. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé¸æŠï¼ˆ1ã‚¯ãƒªãƒƒã‚¯ï¼‰
- [ ] dataå±æ€§è¦ç´„ã®å®Ÿè£…
- [ ] iframeå†…ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- [ ] é¸æŠçŠ¶æ…‹ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
- [ ] Storeæ‹¡å¼µ

### Phase 2: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ
- [ ] ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«UI
- [ ] ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
- [ ] HTMLå†æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯
- [ ] MonacoåŒæœŸ

### Phase 3: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
- [ ] ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º
- [ ] contenteditableåˆ¶å¾¡
- [ ] æ”¹è¡Œâ†’`<br>`å¤‰æ›
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ

### Phase 4: çµ±åˆãƒ»æœ€é©åŒ–
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
- [ ] ã‚¢ãƒ³ãƒ‰ã‚¥/ãƒªãƒ‰ã‚¥å¯¾å¿œ
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆ

---

## 10. æŠ€è¡“çš„ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| sandboxed iframeåˆ¶ç´„ | ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®åˆ¶é™ | postMessageã§åº§æ¨™æƒ…å ±ã‚’é€ä¿¡ã—è¦ªå´ã§å‡¦ç† |
| HTMLæ§‹é€ ã®è¤‡é›‘ã• | è§£æãƒ»å†æ§‹ç¯‰ã®é›£ã—ã• | ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã§æ˜ç¢ºãªå¢ƒç•Œã‚’è¨­å®š |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | å¤§ããªHTMLã§é…å»¶ | ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã€å·®åˆ†æ›´æ–°ã€ä»®æƒ³åŒ–æ¤œè¨ |
| ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®æ¶ˆå¤± | Monacoç·¨é›†ä¸­æ–­ | å¤‰æ›´ç®‡æ‰€ã®ã¿å·®åˆ†æ›´æ–°ã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ä¿å­˜ |

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [email-composer-spec.md](./email-composer-spec.md) - æ—¢å­˜ä»•æ§˜
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- [architecture-diagram.md](./architecture-diagram.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“å›³
